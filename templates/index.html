<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emby Strm Doctor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        emby: '#52B54B',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for logs */
        #log-container::-webkit-scrollbar {
            width: 8px;
        }
        #log-container::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        #log-container::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        #log-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <span class="text-emby">Emby</span> Strm Doctor
            </h1>
            <div class="text-sm text-gray-400">v2.3</div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 flex-grow flex flex-col-reverse md:flex-row gap-6">
        
        <!-- Sidebar / Settings -->
        <aside class="w-full md:w-1/3 lg:w-1/4 space-y-6">
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold mb-4 text-emby border-b border-gray-700 pb-2">è®¾ç½® (Settings)</h2>
                <form id="settings-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Emby Host</label>
                        <input type="text" id="emby_host" placeholder="http://localhost:8096" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-emby text-white placeholder-gray-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">API Key</label>
                        <input type="password" id="api_key" placeholder="Enter API Key" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-emby text-white placeholder-gray-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">User ID</label>
                        <input type="text" id="user_id" placeholder="Enter User ID" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-emby text-white placeholder-gray-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">å®‰å…¨è¯·æ±‚é—´éš” (ç§’)</label>
                        <input type="number" id="scan_interval" min="1" value="5" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-emby text-white">
                        <p class="text-xs text-yellow-500 mt-1">
                            âš ï¸ è­¦å‘Šï¼šé’ˆå¯¹ 115/é˜¿é‡Œäº‘ç›˜/Google Drive ç­‰æŒ‚è½½ç›˜ç”¨æˆ·ï¼Œå»ºè®®è®¾ç½® 5 ç§’ä»¥ä¸Šï¼Œè¿‡å¿«ä¼šå¯¼è‡´è§¦å‘ç½‘ç›˜ API é£æ§ï¼ˆBan IP/Tokenï¼‰ã€‚
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">å•æ¬¡ä»»åŠ¡æ‰«ææ•°é‡é™åˆ¶ (0 ä¸ºä¸é™)</label>
                        <input type="number" id="batch_size" min="0" value="0" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-emby text-white">
                        <p class="text-xs text-gray-400 mt-1">
                            è®¾ç½®æ¯æ¬¡ä»»åŠ¡æœ€å¤šæ‰«æçš„æ–‡ä»¶æ•°ï¼Œé˜²æ­¢ä»»åŠ¡è¿è¡Œæ—¶é—´è¿‡é•¿ã€‚
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">è·¯å¾„é»‘åå•</label>
                        <textarea id="exclude_paths" rows="4" placeholder="/mnt/user/115/\n/mnt/user/aliyun/" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-emby text-white placeholder-gray-500"></textarea>
                        <p class="text-xs text-gray-400 mt-1">ä¸€è¡Œä¸€ä¸ªè·¯å¾„ã€‚ç¤ºä¾‹ï¼š/mnt/user/115/</p>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                        ä¿å­˜é…ç½®
                    </button>
                </form>
            </div>
        </aside>

        <!-- Dashboard -->
        <section class="w-full md:w-2/3 lg:w-3/4 space-y-6">
            
            <!-- Controls -->
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold mb-4 text-emby border-b border-gray-700 pb-2">ä»»åŠ¡é¢æ¿ (Dashboard)</h2>
                
                <div class="flex flex-col sm:flex-row gap-4 items-end">
                    <div class="w-full sm:w-1/2">
                        <label class="block text-sm font-medium text-gray-300 mb-1">é€‰æ‹©åª’ä½“åº“</label>
                        <select id="library-select" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-emby text-white">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div class="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto">
                        <label class="flex items-center text-sm text-gray-300 whitespace-nowrap">
                            <input type="checkbox" id="force_full" class="mr-2 w-5 h-5 sm:w-4 sm:h-4">
                            å¼ºåˆ¶å…¨é‡æ‰«æ
                        </label>
                        <div class="flex gap-2 w-full sm:w-auto justify-end">
                            <button id="btn-refresh-libs" class="bg-gray-600 hover:bg-gray-500 text-white p-3 sm:px-3 sm:py-2 rounded" title="åˆ·æ–°åˆ—è¡¨">
                                ğŸ”„
                            </button>
                            <button id="btn-start" class="flex-1 sm:flex-none bg-emby hover:bg-green-600 text-white font-bold py-3 sm:py-2 px-6 rounded transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                å¼€å§‹ä¿®å¤
                            </button>
                            <button id="btn-stop" class="flex-1 sm:flex-none bg-red-600 hover:bg-red-700 text-white font-bold py-3 sm:py-2 px-6 rounded transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                åœæ­¢
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700 flex flex-col h-80 md:h-[500px]">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                    <h2 class="text-xl font-semibold text-gray-200">å®æ—¶æ—¥å¿—</h2>
                    <button id="btn-clear-logs" class="text-xs text-gray-400 hover:text-white">æ¸…ç©ºæ—¥å¿—</button>
                </div>
                <div id="log-container" class="flex-1 overflow-y-auto font-mono text-sm space-y-1 p-2 bg-gray-900 rounded border border-gray-700">
                    <div class="text-gray-500 italic">ç­‰å¾…ä»»åŠ¡å¼€å§‹...</div>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-4 text-sm">
                    <div class="bg-gray-900 rounded p-3 border border-gray-700">
                        <div class="text-gray-400">ç´¯è®¡æˆåŠŸ</div>
                        <div id="stat-success" class="text-green-400 text-xl">0</div>
                    </div>
                    <div class="bg-gray-900 rounded p-3 border border-gray-700">
                        <div class="text-gray-400">ç´¯è®¡å¤±è´¥</div>
                        <div id="stat-failed" class="text-red-400 text-xl">0</div>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <script>
        const API_BASE = '/api';
        let ws;

        // Elements
        const settingsForm = document.getElementById('settings-form');
        const librarySelect = document.getElementById('library-select');
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        const btnRefreshLibs = document.getElementById('btn-refresh-libs');
        const logContainer = document.getElementById('log-container');
        const btnClearLogs = document.getElementById('btn-clear-logs');

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
            await loadLibraries();
            await loadStatus();
            initWebSocket();
        });

        // Config Logic
        async function loadConfig() {
            try {
                const res = await fetch(`${API_BASE}/config`);
                const data = await res.json();
                document.getElementById('emby_host').value = data.emby_host;
                document.getElementById('api_key').value = data.api_key;
                document.getElementById('user_id').value = data.user_id;
                document.getElementById('scan_interval').value = data.scan_interval;
                document.getElementById('batch_size').value = data.batch_size || 0;
                document.getElementById('exclude_paths').value = data.exclude_paths || '';
            } catch (e) {
                console.error('Failed to load config', e);
            }
        }

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const config = {
                emby_host: document.getElementById('emby_host').value,
                api_key: document.getElementById('api_key').value,
                user_id: document.getElementById('user_id').value,
                scan_interval: parseInt(document.getElementById('scan_interval').value),
                batch_size: parseInt(document.getElementById('batch_size').value),
                exclude_paths: document.getElementById('exclude_paths').value
            };
            
            try {
                const res = await fetch(`${API_BASE}/config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                if (res.ok) {
                    alert('é…ç½®å·²ä¿å­˜');
                    loadLibraries(); // Refresh libraries with new config
                } else {
                    alert('ä¿å­˜å¤±è´¥');
                }
            } catch (e) {
                console.error(e);
                alert('ä¿å­˜å‡ºé”™');
            }
        });

        // Libraries Logic
        async function loadLibraries() {
            librarySelect.innerHTML = '<option>åŠ è½½ä¸­...</option>';
            try {
                const res = await fetch(`${API_BASE}/libraries`);
                if (!res.ok) throw new Error('Failed to fetch libraries');
                const items = await res.json();
                
                librarySelect.innerHTML = '';
                if (items.length === 0) {
                    librarySelect.innerHTML = '<option value="">æœªæ‰¾åˆ°åª’ä½“åº“</option>';
                    return;
                }
                
                items.forEach(lib => {
                    const opt = document.createElement('option');
                    opt.value = lib.Id;
                    opt.textContent = lib.Name;
                    librarySelect.appendChild(opt);
                });
            } catch (e) {
                console.error(e);
                librarySelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ (è¯·æ£€æŸ¥é…ç½®)</option>';
            }
        }

        btnRefreshLibs.addEventListener('click', loadLibraries);

        // Task Control
        btnStart.addEventListener('click', async () => {
            const libraryId = librarySelect.value;
            if (!libraryId) return alert('è¯·é€‰æ‹©ä¸€ä¸ªåª’ä½“åº“');
            const force = document.getElementById('force_full').checked;

            try {
                const res = await fetch(`${API_BASE}/start`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ library_id: libraryId, force })
                });
                const data = await res.json();
                if (res.ok) {
                    setRunningState(true);
                    appendLog('>>> ä»»åŠ¡å¯åŠ¨æŒ‡ä»¤å·²å‘é€');
                } else {
                    alert(data.detail || 'å¯åŠ¨å¤±è´¥');
                }
            } catch (e) {
                alert('å¯åŠ¨è¯·æ±‚å‡ºé”™');
            }
        });

        btnStop.addEventListener('click', async () => {
            try {
                // UI feedback
                btnStop.disabled = true;
                btnStop.textContent = 'æ­£åœ¨åœæ­¢...';
                btnStop.classList.add('opacity-50', 'cursor-not-allowed');

                const res = await fetch(`${API_BASE}/stop`, { method: 'POST' });
                if (res.ok) {
                    appendLog('>>> åœæ­¢æŒ‡ä»¤å·²å‘é€');
                } else {
                    // Revert UI if request failed
                    btnStop.disabled = false;
                    btnStop.textContent = 'åœæ­¢';
                    btnStop.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } catch (e) {
                console.error(e);
                // Revert UI if request failed
                btnStop.disabled = false;
                btnStop.textContent = 'åœæ­¢';
                btnStop.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        async function loadStatus() {
            try {
                const res = await fetch(`${API_BASE}/status`);
                if (!res.ok) return;
                const data = await res.json();
                if (data.is_running) {
                    setRunningState(true);
                    if (data.current_library_id) {
                        librarySelect.value = data.current_library_id;
                    }
                } else {
                    setRunningState(false);
                }
                if (data.db_stats) {
                    document.getElementById('stat-success').textContent = data.db_stats.success || 0;
                    document.getElementById('stat-failed').textContent = data.db_stats.failed || 0;
                }
            } catch (e) {
                console.warn('Status fetch failed', e);
            }
        }

        function setRunningState(isRunning) {
            btnStart.disabled = isRunning;
            
            // Reset Stop Button State
            btnStop.textContent = 'åœæ­¢';
            btnStop.disabled = !isRunning;
            
            if (isRunning) {
                btnStart.classList.add('opacity-50', 'cursor-not-allowed');
                btnStop.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
                btnStop.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // WebSocket & Logs
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onmessage = (event) => {
                const msg = event.data;
                appendLog(msg);
                
                if (msg.includes('ä»»åŠ¡å®Œæˆ') || msg.includes('ä»»åŠ¡å·²æ‰‹åŠ¨åœæ­¢') || msg.includes('ä»»åŠ¡è‡ªåŠ¨åœæ­¢') || msg.includes('ç”¨æˆ·å·²æ‰‹åŠ¨ç»ˆæ­¢ä»»åŠ¡') || msg.includes('èº«ä»½éªŒè¯å¤±è´¥') || msg.includes('èº«ä»½éªŒè¯å¼‚å¸¸')) {
                    setRunningState(false);
                }
            };

            ws.onclose = () => {
                console.log('WS Disconnected, retrying in 3s...');
                setTimeout(initWebSocket, 3000);
            };
        }

        function appendLog(text) {
            const div = document.createElement('div');
            // Timestamp
            const time = new Date().toLocaleTimeString();
            
            // Color coding based on content
            let colorClass = 'text-gray-300';
            if (text.includes('æˆåŠŸ')) colorClass = 'text-green-400';
            else if (text.includes('å¤±è´¥') || text.includes('é”™è¯¯') || text.includes('å¼‚å¸¸') || text.includes('èº«ä»½éªŒè¯å¤±è´¥')) colorClass = 'text-red-400';
            else if (text.includes('è­¦å‘Š')) colorClass = 'text-yellow-400';
            else if (text.includes('æ­£åœ¨') || text.includes('èº«ä»½ç¡®è®¤')) colorClass = 'text-blue-300';

            div.className = `${colorClass} break-all`;
            
            // Check if text contains HTML tags (simple check)
            if (text.trim().startsWith('<')) {
                 div.innerHTML = `<span class="text-gray-600 select-none">[${time}]</span> ${text}`;
            } else {
                 div.innerHTML = `<span class="text-gray-600 select-none">[${time}]</span> ${text}`;
            }
            
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        btnClearLogs.addEventListener('click', () => {
            logContainer.innerHTML = '';
        });

    </script>
</body>
</html>
